name: ci
on:
  push:
  workflow_dispatch:
jobs:
  test:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - run: make test
        shell: bash
  action-test:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    env:
      TEST_BSR_COMMIT: feedfacecafefeedfacecafefeedface
    steps:
      - uses: actions/checkout@v2
      - name: setup fake buf
        shell: bash
        run: |
          mkdir -p tmp/bin
          cp test/buf.bash tmp/bin/buf
          chmod +x tmp/bin/buf
          echo "${PWD}/tmp/bin" >> "${GITHUB_PATH}"
      - name: run action
        id: run-action
        uses: ./
        with:
          buf_token: fake-buf-token
          input: test/proto
          track: fake-track
        env:
          WANT_BUF_TOKEN: fake-buf-token
          WANT_ARGS: push --tag ${{ github.sha }} test/proto --track fake-track
      - name: check output
        env:
          GOT_COMMIT: ${{ steps.run-action.outputs.commit }}
          GOT_COMMIT_URL: ${{ steps.run-action.outputs.commit_url }}
        shell: bash
        run: |
          set -e
          if [[ "${GOT_COMMIT}" != "${TEST_BSR_COMMIT}" ]]; then
            echo "Expected commit ${TEST_BSR_COMMIT} but got ${GOT_COMMIT}"
            exit 1
          fi
          if [[ "${GOT_COMMIT_URL}" != "https://buf.build/example/repo/tree/${TEST_BSR_COMMIT}" ]]; then
            echo "Expected commit url ${TEST_BSR_COMMIT_URL} but got ${GOT_COMMIT_URL}"
            exit 1
          fi
